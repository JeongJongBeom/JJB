<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jjb.mapper.BoardMapper">
	<select id="boardlist" resultType="com.jjb.model.BoardVO">
		<!-- CDATA를 사용해야 부등호 표시(크다,작다)와 닫거나 열거나할때의 <>를 구분해줄수 있음 -->
	<![CDATA[
		select * from ${name}
	]]>
	</select>

	<select id="boardListPage" resultType="com.jjb.model.BoardVO">
		<!-- CDATA를 사용해야 부등호 표시(크다,작다)와 닫거나 열거나할때의 <>를 구분해줄수 있음 -->

		select *
		from (select @rownum:=@rownum+1 as
		rownum, bno, content,
		nickname,
		regdate, udate,section
		<if test="bsNum == 'B2-01'">
			, imgname, userid, category
		</if>
		<if test="bsNum == 'B3-01'">
			,contentImg, imgname, userid,profileImg
		</if>
		<if test="bsNum == 'B4-01'|| bsNum == 'B2-01'">
			,title, cnt
		</if>

		<if test="bsNum == 'B4-02' || bsNum == 'B4-03' || bsNum == 'B4-04'">
			,title, cnt, userid,filename, imgname
		</if>
		
		<if test="bsNum == 'B6-01'">
			,title, userid, answer
		</if>
		
		from (select @rownum:=0) as rownum
		, ${bsection}
		where section =
		#{bsNum}

		<if test="cri.keyword!=null">
			and title like concat('%',#{cri.keyword},'%')
		</if>
		<if test="board.category!=null">
			and category like concat('%',#{board.category},'%')
		</if>
		<if test="bsNum == 'B6-01'">
			and userid=#{sessionid}
		</if>
		order by <choose>
				<when test="order == 1">
					cnt
				</when>
				<otherwise>
					bno
				</otherwise>
			</choose> desc) ${bsection} 
	<![CDATA[
		where rownum >(#{cri.pageNum}-1)*#{cri.amount} and rownum<=#{cri.pageNum}*#{cri.amount}
		;
	]]>
	</select>

	<select id="boardCount" resultType="int">
		select count(*) from ${bsection}
		where section = #{bsNum}
		<if test="cri.keyword!=null">
			and title like concat('%',#{cri.keyword},'%')
		</if>
		<if test="board.category!=null">
			and category like concat('%',#{board.category},'%')
		</if>
	</select>

	<select id="boardDetail" resultType="com.jjb.model.BoardVO">
		select * from ${bsection}
		where bno=#{bno}
	</select>

	<insert id="boardWrite">
		insert into ${bsection} (nickname, userid, content,
		regdate, imgname, section, countImg
		<if test="bsNum=='B3-01'">
		, contentImg
		</if>
		<if test="bsNum=='B2-01'">
			,title,category
		</if>
		) values
		(#{nickname},#{userid},
		#{board.content},sysdate(), #{board.imgname},
		#{board.section},#{board.countImg}
		<if test="bsNum=='B3-01'">
		,#{board.contentImg}
		</if>
		<if test="bsNum=='B2-01'">
			,#{board.title},#{board.category}
		</if>
		)
	</insert>

	<update id="boardModify">
		update ${bsection} set content = #{board.content}, imgname = #{board.imgname},
		countImg = #{board.countImg}, udate = sysdate()
		<choose>
			<when test="board.section=='B3-01'">
				,contentImg= #{board.contentImg}
			</when>
			<when test="board.section=='B2-01'">
				,title=#{board.title}
			</when>
		</choose>
		where bno=#{board.bno}
	</update>

	<delete id="boardDelete">
		delete from ${bsection} where bno=#{bno}
	</delete>

	<select id="RepCount" resultType="int">
		select count(*) from
		${rsection} where bno=#{bno}
	</select>

	<select id="repBoardListPage"
		resultType="com.jjb.model.RepBoardVO">
		<!-- CDATA를 사용해야 부등호 표시(크다,작다)와 닫거나 열거나할때의 <>를 구분해줄수 있음 -->
		select *
		from
		(select @rownum:=@rownum+1 as rownum, rno, content,
		userid, nickname
		<if
			test="bsNum == 'B4-01' || bsNum == 'B4-02' || bsNum == 'B4-03' || bsNum == 'B4-04'">
			,section
		</if>
		,udate, likeno

		from (select @rownum:=0) as rownum
		, ${rsection}
		where bno
		= #{bno}
		<if
			test="bsNum == 'B4-01' || bsNum == 'B4-02' || bsNum == 'B4-03' || bsNum == 'B4-04'">
			and section = #{rsNum}
		</if>
		order by rno desc)
		${rsection} 
	<![CDATA[
		where rownum >(#{cri.pageNum}-1)*#{cri.amount} and rownum<=#{cri.pageNum}*#{cri.amount}
		;
	]]>
	</select>

	<insert id="repWrite">
		insert into ${rsection} (bno, userid, nickname,
		content, regdate, section) values
		(#{reboard.bno},#{reboard.userid},#{reboard.nickname},#{reboard.content},sysdate(),#{rsNum});
	</insert>

	<update id="repModify">
		update ${rsection} set content=#{reboard.content},
		udate = sysdate() where rno=#{reboard.rno};
	</update>

	<delete id="repDelete">
		delete from ${rsection} where rno = #{rno};
	</delete>

	<select id="ModifyList" resultType="com.jjb.model.BoardVO">
		select * from ${bsection}
		where bno=#{bno};
	</select>
	
	<update id="addViewCnt">
		update ${bsection} set cnt = cnt+1 where bno=#{bno};
	</update>
	
	<select id="likeck" resultType="int">
		select count(*) from tbl_like where userid = #{userid} and section =#{board.section} and bno = #{board.bno}
	</select>
	
	<insert id="like">
		insert into tbl_like (userid, section, bno) values (#{userid}, #{board.section}, #{board.bno});
	</insert>
	
	<delete id="unlike">
		delete from tbl_like where userid=#{userid} and section=#{board.section} and bno=#{board.bno};
	</delete>
	
	<select id="followck" resultType="int">
		select count(*) from follow_user where userid=#{userid} and chef_followed=#{board.userid}
	</select>
	
	<insert id="searchKeyword">
		insert into tbl_search (userid, keyword, regdate) values (#{userid}, #{keyword}, now());
	</insert>
	
	<select id="RecentKeyword" resultType="String">
		select keyword, count(*) from tbl_search where regdate >= (SELECT DATE_ADD(NOW(), INTERVAL -7 DAY)) group by keyword order by count(*) desc
	</select>
	
	<select id="orderRecipe" resultType="com.jjb.model.BoardVO">
		select * from tbl_recipe order by
			<choose>
				<when test="order == 0">
					regdate
				</when>
				<when test="order == 1">
					cnt
				</when>
			</choose>
		desc
	</select>
	
	<select id="orderRecipe_like" resultType="com.jjb.model.BoardVO">
		select a.bno,count(*),title, imgname from tbl_like a left join tbl_recipe b on a.bno = b.bno where a.section ='B2-01' group by bno order by count(*) desc
	</select>
	
	<select id="likePaging" resultType="com.jjb.model.BoardVO">
		select rownum,bno, nickname, section, imgname, userid, title, count 
		from (select @rownum:=@rownum+1 as rownum, bno, nickname, section, imgname, userid, title, count		
		from (select @rownum:=0) as rownum, (select a.bno, nickname, section, imgname, userid, title, if(count is null, 0, count) as count from (select bno, nickname, section, imgname, userid, title
		from tbl_recipe) a left join (select a.bno,count(*) as count from tbl_like a right join tbl_recipe b on a.bno = b.bno where a.section ='B2-01' group by bno order by count(*) desc) b
        on a.bno = b.bno order by count desc) tbl_recipe) tbl_recipe 
		<![CDATA[
		where rownum >(#{cri.pageNum}-1)*#{cri.amount} and rownum<=#{cri.pageNum}*#{cri.amount}
		]]>
	</select>
	
</mapper>